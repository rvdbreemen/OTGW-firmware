name: Sync Wiki Documentation

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'docs/wiki/**'
      - '.github/workflows/sync-wiki.yml'

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    name: Sync wiki to GitHub Pages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git config
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Clone wiki repository
        run: git clone https://github.com/${{ github.repository }}.wiki.git wiki-repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy wiki files
        run: |
          cp -v docs/wiki/*.md wiki-repo/ || true
          echo "Wiki files copied to wiki-repo"

      - name: Update wiki navigation sidebar
        run: |
          cd wiki-repo
          
          # Update _Sidebar.md if it doesn't have v3 section
          if [ ! -f _Sidebar.md ] || ! grep -q "API-v3-Overview" _Sidebar.md; then
            {
              echo "## Quick Navigation"
              echo ""
              echo "### REST API Documentation"
              echo ""
              echo "#### API v3 (Recommended)"
              echo "- [[1-API-v3-Overview]]"
              echo "- [[2-Quick-Start-Guide]]"
              echo "- [[3-Complete-API-Reference]]"
              echo "- [[4-Migration-Guide]]"
              echo "- [[6-Error-Handling-Guide]]"
              echo "- [[7-HATEOAS-Navigation-Guide]]"
              echo ""
              echo "#### Reference"
              echo "- [[5-Changelog]]"
              echo "- [[8-Troubleshooting]]"
              echo ""
              echo "### Installation & Setup"
              echo "- [[How to install firmware on your ESP]]"
              echo "- [[Configure WiFi settings using the Web UI]]"
              echo "- [[How to compile the OTGW firmware]]"
              echo ""
              echo "### Usage Guides"
              echo "- [[How to use with OTmonitor]]"
              echo "- [[How to use it with Home Assistant, Homey or Domoticz or others]]"
              echo "- [[How to send commands to the OTGW with MQTT or REST or Net2Ser]]"
              echo "- [[Using the MQTT set commands]]"
              echo ""
              echo "### Advanced Topics"
              echo "- [[How to debug the OTGW firmware]]"
              echo "- [[How to upload files to LittleFS]]"
              echo "- [[Using DS18B20 sensor with ESP firmware]]"
              echo "- [[The meaning of the blue LEDs]]"
              echo "- [[Upgrade to new release using Over The Air flashing]]"
            } > _Sidebar.md
          fi
          
          cd ..
          echo "Navigation sidebar updated"

      - name: Check for changes
        id: check-changes
        run: |
          cd wiki-repo
          git add -A
          
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected, proceeding with sync"
          fi

      - name: Commit and push wiki changes
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          cd wiki-repo
          git commit -m "docs: Sync wiki from main repo (commit: ${{ github.sha }})"
          git push origin master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report sync status
        run: |
          echo "Wiki sync completed"
          echo "Repository: ${{ github.repository }}"
          echo "Wiki available at: https://github.com/${{ github.repository }}/wiki"
