<!DOCTYPE html>
<html charset="UTF-8">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <link rel="stylesheet" type="text/css" href="./index.css" id="theme-style">
    <script>
      (function() {
        try {
          var storedTheme = localStorage.getItem('theme');
          if (storedTheme === 'dark') {
            document.getElementById('theme-style').href = "index_dark.css";
          }
        } catch (e) { console.error(e); }
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="./index.js"></script>
    <script src="./graph.js"></script>
    <title>OTGW firmware</title>
  </head>
  <body>
    <font face="Arial">
    <div class="headerrow">
        <div class="headercolumnbig" id="sysName">OTGW firmware</div>
        <div class="headercolumn" id="devName">[hostname]</div>
        <div class="headercolumn" id="devVersion">[version]</div>
        <div class="headercolumn" id='theTime'>[00:00:00]</div>
    </div>
    </font>
    <div id="displayMainPage" class="page-section active">
      <div class="nav-container">
        <div class='nav-left'>
          <button class='home nav-item tabButton'>Home</button>
        </div>
        <div class='nav-right'>
          <button class='basicSettings nav-item tabButton'>Settings</button>
          <button class='adminSettings nav-item tabButton'>Advanced</button>
          <div class="adv_dropdown hidden">
            <span class="list_item tabPICflash">PIC firmware</span>
            <span class="list_item tabDeviceInfo">Debug Information</span>
            <span class="list_item FSexplorer">File system contents</span>
          </div>
        </div>
      </div>
      <div id="mainPage">
        <div id="waiting">Wait for it...</div>
      </div>
      
      <!-- OpenTherm Log Viewer Section -->
      <div id="otLogSection" class="ot-log-section">
        <div class="ot-log-header">
          <h3>OpenTherm Monitor</h3>
          <div class="ot-log-status">
            <span id="wsStatus" class="ws-status ws-disconnected">‚óè</span>
            <span id="wsStatusText">Disconnected</span>
          </div>
        </div>
        
        <div class="ot-log-tabs">
          <button class="tab-link active" onclick="openLogTab(event, 'Log')">Log</button>
          <button class="tab-link" onclick="openLogTab(event, 'Statistics')">Statistics</button>
          <button class="tab-link" onclick="openLogTab(event, 'Graph')">Graph</button>
        </div>

        <div id="Log" class="tab-content active">
            <div class="ot-log-controls">
              <button id="btnToggleLog" class="btn-log-control" title="Expand/Collapse Log" aria-label="Expand or collapse the OpenTherm log view">‚ñ≤ Show More</button>
              <button id="btnAutoScroll" class="btn-log-control btn-active" title="Auto-scroll with new messages" aria-label="Toggle auto-scroll with new log messages">Auto-scroll</button>
              <button id="btnClearLog" class="btn-log-control" title="Clear log buffer" aria-label="Clear the OpenTherm log buffer">Clear</button>
              <div class="download-dropdown">
                <button id="btnDownloadLog" class="btn-log-control" title="Download log to file" aria-label="Download the OpenTherm log to a file">Download ‚ñº</button>
                <div class="download-menu hidden">
                  <div class="download-menu-item" data-format="txt">Text (.txt)</div>
                  <div class="download-menu-item" data-format="json">JSON (.json)</div>
                  <div class="download-menu-item" data-format="csv">CSV (.csv)</div>
                </div>
              </div>
              <div class="download-dropdown">
                <button id="btnImportLog" class="btn-log-control" title="Import log from file" aria-label="Import OpenTherm log from a file">Import ‚ñº</button>
                <div class="download-menu hidden">
                  <div class="download-menu-item" data-format="json">JSON (.json)</div>
                  <div class="download-menu-item" data-format="csv">CSV (.csv)</div>
                  <div class="download-menu-item" data-format="txt">Text (.txt)</div>
                </div>
              </div>
              <input type="file" id="fileImportInput" style="display:none" accept=".json,.csv,.txt" />
              <label class="log-control-label" style="display:inline-flex;" title="Automatically save log every 15 minutes">
                  <input type="checkbox" id="chkAutoDownloadLog" aria-label="Auto download log every 15 minutes" />
                  Auto
              </label>
              <input type="text" id="searchLog" class="log-search" placeholder="Search logs..." aria-label="Search OpenTherm log messages" />
              <label class="log-control-label" title="Show timestamps in log view">
                <input type="checkbox" id="chkShowTimestamp" checked aria-label="Show timestamps in the OpenTherm log" />
                Timestamps
              </label>
              <label class="log-control-label" title="Capture up to 1M lines in memory">
                <input type="checkbox" id="chkCaptureMode" aria-label="Capture large amount of data (up to 1M lines)" />
                Capture
              </label>
              <label class="log-control-label" id="lblStreamToFile" title="Stream logs directly to a local file (Chrome/Edge only)">
                <input type="checkbox" id="chkStreamToFile" aria-label="Stream log data to a file" />
                Stream
              </label>
            </div>
            
            <div id="otLogContainer" class="ot-log-container collapsed">
              <div id="otLogContent" class="ot-log-content" role="log" aria-live="polite"></div>
            </div>
            
            <div class="ot-log-footer">
              <span>Lines: <span id="logLineCount">0</span><span id="logLimitDisplay"> / 2000</span></span>
              <span>Filtered: <span id="logFilteredCount">0</span></span>
              <span>Mem: <span id="memUsage">0</span> MB</span>
              <span id="memUsageDetailed" class="mem-status"></span>
              <span id="storageStatus" class="storage-status"></span>
              <span id="logFileDisplay" style="display:none">Log: <span id="currentLogFile">None</span></span>
              <div id="recoveryProgress" style="display:none; margin-top: 5px; font-style: italic;"></div>
            </div>
            
            <!-- Storage Settings Panel (Phase 5) -->
            <div class="storage-settings-panel">
              <button id="btnToggleStorageSettings" class="btn-storage-toggle" title="Show/hide storage settings">
                ‚öô Storage Settings
              </button>
              <div id="storageSettingsContent" class="storage-settings-content hidden">
                <div class="storage-settings-row">
                  <label for="selectStorageMode">
                    <strong>Storage Mode:</strong>
                    <select id="selectStorageMode" class="storage-select">
                      <option value="disabled">Disabled (Memory Only)</option>
                      <option value="smart" selected>Smart (Recommended)</option>
                      <option value="indexeddb">Always IndexedDB</option>
                      <option value="localstorage">Always localStorage</option>
                    </select>
                  </label>
                  <span id="storageModeInfo" class="storage-info">Auto-selects best storage based on data size</span>
                </div>
                
                <div class="storage-settings-row">
                  <label for="selectRetentionPeriod">
                    <strong>Retention Period:</strong>
                    <select id="selectRetentionPeriod" class="storage-select">
                      <option value="1">1 Day</option>
                      <option value="7" selected>7 Days</option>
                      <option value="14">14 Days</option>
                      <option value="30">30 Days</option>
                      <option value="90">90 Days</option>
                      <option value="0">Forever (Until Full)</option>
                    </select>
                  </label>
                  <span id="retentionInfo" class="storage-info">Next cleanup: <span id="nextCleanupDate">-</span></span>
                </div>
                
                <div class="storage-settings-row">
                  <button id="btnViewSessions" class="btn-storage-action" title="Browse saved log sessions">
                    üìã Browse Sessions
                  </button>
                  <button id="btnCleanupNow" class="btn-storage-action" title="Clean up old sessions now">
                    üßπ Clean Up Old Sessions
                  </button>
                  <button id="btnClearAllStorage" class="btn-storage-action btn-danger" title="Clear all stored data (cannot be undone)">
                    üóë Clear All Storage
                  </button>
                </div>
                
                <div class="storage-usage-dashboard" id="storageUsageDashboard">
                  <h4>Storage Usage</h4>
                  <div class="storage-usage-bars">
                    <div class="storage-usage-item">
                      <div class="storage-usage-label">
                        <span>IndexedDB:</span>
                        <span id="indexeddbUsageText">0 MB</span>
                      </div>
                      <div class="storage-usage-bar">
                        <div id="indexeddbUsageBar" class="storage-usage-fill" style="width: 0%"></div>
                      </div>
                    </div>
                    <div class="storage-usage-item">
                      <div class="storage-usage-label">
                        <span>localStorage:</span>
                        <span id="localstorageUsageText">0 KB</span>
                      </div>
                      <div class="storage-usage-bar">
                        <div id="localstorageUsageBar" class="storage-usage-fill" style="width: 0%"></div>
                      </div>
                    </div>
                    <div class="storage-usage-item">
                      <div class="storage-usage-label">
                        <span>Total Quota:</span>
                        <span id="totalQuotaText">0 MB / 0 MB</span>
                      </div>
                      <div class="storage-usage-bar">
                        <div id="totalQuotaBar" class="storage-usage-fill" style="width: 0%"></div>
                      </div>
                    </div>
                  </div>
                  <div id="sessionsList" class="sessions-list"></div>
                </div>
              </div>
            </div>
        </div>

        <div id="Statistics" class="tab-content">
             <div class="ot-stats-container">
                <table class="ot-stats-table" id="otStatsTable">
                    <thead>
                        <tr>
                            <th onclick="sortStats(0)">Hex</th>
                            <th onclick="sortStats(1)">Dec</th>
                            <th onclick="sortStats(2)">Direction</th>
                            <th onclick="sortStats(3)">Description</th>
                            <th onclick="sortStats(4)">Interval (s)</th>
                            <th onclick="sortStats(5)">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
             </div>
             <div class="ot-log-footer">
                <span>Unique Messages: <span id="statsCount">0</span></span>
             </div>
        </div>

        <div id="Graph" class="tab-content">
            <div class="ot-graph-container">
               <div class="ot-graph-controls">
                   <div class="ot-graph-group">
                       <label for="graphTimeWindow">Time Window: </label>
                       <select id="graphTimeWindow" class="ot-graph-time-window">
                           <option value="10">10 Minutes</option>
                           <option value="30">30 Minutes</option>
                           <option value="60" selected>1 Hour</option>
                           <option value="120">2 Hours</option>
                           <option value="240">4 Hours</option>
                           <option value="360">6 Hours</option>
                           <option value="720">12 Hours</option>
                           <option value="1440">24 Hours</option>
                       </select>
                   </div>

                   <div class="ot-graph-group">
                       <button id="btnGraphScreenshot" class="nav-item">Screenshot</button>
                       <label class="log-control-label" title="Automatically save screenshot every 15 minutes">
                           <input type="checkbox" id="chkAutoScreenshot" />
                           Auto-save PNG
                       </label>
                   </div>

                   <div class="ot-graph-group">
                       <button id="btnGraphExport" class="nav-item">Export Data</button>
                       <label class="log-control-label" title="Automatically export CSV data every 15 minutes">
                           <input type="checkbox" id="chkAutoExport" />
                           Auto-save CSV
                       </label>
                   </div>
               </div>
               <div id="otGraphCanvas"></div>
            </div>
        </div>
      </div>
    </div>
    <div id="displayPICflash" class="page-section">
      <div class="nav-container">
        <div class='nav-left'>
          <button class='home nav-item tabButton'>Home</button>
        </div>
        <div class='nav-right'>
          <button class='basicSettings nav-item tabButton'>Settings</button>
          <button class='adminSettings nav-item tabButton'>Advanced</button>
          <div class="adv_dropdown hidden">
            <span class="list_item tabPICflash">PIC firmware</span>
            <span class="list_item tabDeviceInfo">Debug Information</span>
            <span class="list_item FSexplorer">File system contents</span>
          </div>
        </div>
      </div>
      <div id="displayPICpage"></div>
    </div>
    <div id="displayDeviceInfo" class="page-section">
      <div class="nav-container">
        <div class='nav-left'>
          <button class='home nav-item tabButton'>Home</button>
        </div>
        <div class='nav-right'>
          <button class='basicSettings nav-item tabButton'>Settings</button>
          <button class='adminSettings nav-item tabButton'>Advanced</button>
          <div class="adv_dropdown hidden">
            <span class="list_item tabPICflash">PIC firmware</span>
            <span class="list_item tabDeviceInfo">Debug Information</span>
            <span class="list_item FSexplorer">File system contents</span>
          </div>
        </div>
      </div>
      <div id="deviceinfoPage"></div>
    </div>
    <div id="displaySettingsPage" class="page-section">
      <div class="nav-container">
        <div class='nav-left'>
          <button class='home nav-item tabButton'>Home</button>
        </div>
        <div class='nav-right'>
          <button class='basicSettings nav-item tabButton'>Settings</button>
          <button class='adminSettings nav-item tabButton'>Advanced</button>
          <div class="adv_dropdown hidden">
            <span class="list_item tabPICflash">PIC firmware</span>
            <span class="list_item tabDeviceInfo">Debug Information</span>
            <span class="list_item FSexplorer">File system contents</span>
          </div>
        </div>
      </div>
      <div id="settingsPage"></div>
      <div id="settingMessage">Loading...</div>
    </div>
    <div class="footer">
      <div class="nav-left">
        <button class='nav-item tabButton btnSaveSettings hidden'>Save</button>
      </div>
    </div>
    <!-- KEEP THIS --->

    <!-- Pin to bottom right corner -->
    <div class="bottom right-0">2021-2026 &copy; Robert van den Breemen</div>

    <!-- Pin to bottom left corner -->
    <div id="message" class="bottom left-0"></div>
  
    <script>
       window.onload=initMainPage;
    </script>

  </body>

</html>
